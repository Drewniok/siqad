Simulation Tool for Q\+Si\textquotesingle{}s dangling bonds. There are two proposed contributions\+: \begin{DoxyVerb}1. A CAD tool to assist in designing arrangements of dangling bonds on the surface.

2. A set of physics tools for the simulations of these arrangements.
\end{DoxyVerb}


\subsection*{Prerequisites}

\paragraph*{G\+UI}

The G\+UI is currently written in C++ and uses the Qt5 framework. The Qt5 framework will need to be installed in order to compile the source\+:


\begin{DoxyEnumerate}
\item The latest Qt5 source can be installed from \href{https://github.com/qt/qt5,}{\tt https\+://github.\+com/qt/qt5,} see their R\+E\+A\+D\+ME for build instructions.
\item Alternatively, an installer for the latest stable framework can be obtained from \href{https://www.qt.io/download/}{\tt https\+://www.\+qt.\+io/download/}. Currently, all source code for the G\+UI can fall under the G\+NU L\+G\+PL v3 license so select \char`\"{}\+Open source distribution...\char`\"{}. This may change in future.
\end{DoxyEnumerate}

Depending on your installation method, you may need to first install Qt5 dependencies. On debian systems, these can be installed as (build-\/essential, libfontconfig1, mesa-\/common-\/dev, libglu1-\/mesa-\/dev).

\subsection*{Building}

There is currently no installer binary so the tool must be built from source. Development has been done purely in Linux and there has been no modification made to the .pro file to account for any additional O\+S-\/specified linking/includes.

If you are going to load the source as a project in Qt Creator, make a copy of the .pro file before first compile to prevent including unnecessary formatting in the official version. When committing your code, move only the necessary changes into the official .pro file with comments as needed.

\subsubsection*{Ubuntu compilation}

This tutorial is based off Ubuntu 17.\+10. First, clone the repository (including submodules) onto your local machine using the following command\+:


\begin{DoxyCode}
1 git clone --recurse-submodules https://github.com/retallickj/qsi-sim.git
\end{DoxyCode}


You may be prompted for your Github credentials as this is a private repository. Next, install required dependencies\+:


\begin{DoxyCode}
1 sudo apt install python3-pip python3-tk make gcc g++ qtchooser qt5-default libqt5svg5* qttools5-dev
       qttools5-dev-tools libboost-dev libboost-filesystem-dev libboost-system-dev
2 sudo pip3 install matplotlib numpy pyqt5
\end{DoxyCode}


Next, compile the physics engines. The Marcus simulator is the exciting deal now so that will be the only one built in this tutorial. Build the A\+FM Marcus simulator\+:


\begin{DoxyCode}
1 cd qsi-sim/src/phys/afmmarcus/src
2 make
\end{DoxyCode}


Then compile the G\+UI (without sudo)\+:


\begin{DoxyCode}
1 cd ../../../..
2 qmake && make install
\end{DoxyCode}


Don\textquotesingle{}t be alarmed by the {\ttfamily make install}, this won\textquotesingle{}t install the simulator to your system as long as you don\textquotesingle{}t run it as sudo. All it does is compile the binaries and copy the physics simulation files over to the compiled folders.

Finally, run {\ttfamily ./build/debug/db-\/sim} (from the qsi-\/sim directory) to run the G\+UI. In order to run a hopping animation, create a DB layout, click on the play button on the top bar, choose the \char`\"{}\+Hopping Animator\char`\"{} engine and run. To run a line scan (which only supports one line for now, the top one), choose the \char`\"{}\+A\+F\+M Line Scan\char`\"{} engine. Test that the engine actually works by running a small layout first. If the Sim Visualize side bar appears on the right side without a pop-\/up window showing the line scan or the hopping animation, click \char`\"{}\+Show Terminal Output\char`\"{} and send Samuel the content for debugging. If you\textquotesingle{}re running a large layout (a few Q\+CA cells are already large), it might just take longer for the animation to show up.

The simulation parameters form is very barebones right now consisting of only textboxes, improvements will be made shortly. Electrode and A\+FM paths have not been fully integrated for simulation yet, they will also be added soon.

\subsection*{Licensing}

The open source version of Qt5 falls under the G\+NU L\+G\+PL v3 license, as does the G\+UI code. Qt5 includes some packages which include third-\/party content under different licenses. If these are used their specific licenses must be considered. Refer to \href{http://doc.qt.io/qt-5/licenses-used-in-qt.html}{\tt http\+://doc.\+qt.\+io/qt-\/5/licenses-\/used-\/in-\/qt.\+html} for a list of third-\/party licensed libraries.

\section*{T\+O\+DO}

\begin{quote}
content directly related to the G\+UI and not any solver or physics functionality \end{quote}
\subsection*{G\+UI}

\subsubsection*{Generic}


\begin{DoxyItemize}
\item Save DB layouts and load from save
\begin{DoxyItemize}
\item $\sim$$\sim$\+Save load script for each class$\sim$$\sim$ Implemented 17.\+08.\+09
\item $\sim$$\sim$\char`\"{}\+You have unsaved changes...\char`\"{}$\sim$$\sim$ Implemented 17.\+08.\+22
\item $\sim$$\sim$\+C-\/s C-\/\+Shift-\/s shortcuts$\sim$$\sim$ Implemented
\item $\sim$$\sim$\+Periodic autosave$\sim$$\sim$ 17.\+08.\+22
\item Autorecovery
\end{DoxyItemize}
\item Reseting design panel doesn\textquotesingle{}t reset tool type to Select
\item Don\textquotesingle{}t deselect cells when entering Panning mode
\item When using D\+B\+Gen Tool, show ghosts indicating where D\+Bs will be created
\item Labels (input, output, other arbitrary labels)
\item Screen capture tool options (light background mode, capture area)
\item C\+MI mode (e.\+g. single command to run batch simulations)
\item Shift + middle click drag \char`\"{}zoom to region\char`\"{}
\item Dialog panel add H\+T\+ML color processing (and regex remove H\+T\+ML tags when writing to log)
\item Make function that determines whether specific actions are allowed in current display mode
\item Break gui\+::\+Application\+G\+U\+I\+::save\+To\+File apart to a modular file writer, and pick what to include in the output file
\item $\sim$$\sim$\+Esc cancels paste operation$\sim$$\sim$ Implemented 17.\+07.\+13
\item $\sim$$\sim$\+Esc cancels DB Tool$\sim$$\sim$ Implemented 17.\+07.\+13
\item $\sim$$\sim$\+Visual feedback on which tool is currently in use (e.\+g. changed background of the button)$\sim$$\sim$ Implemented 17.\+07.\+12
\item Content Menu
\begin{DoxyItemize}
\item $\sim$$\sim$\+Generic Undo, Redo, Cut, Copy, Paste, Delete$\sim$$\sim$ 17.\+12.\+07
\item $\sim$$\sim$\+Dot specific\+: Toggle selected dots between Lattice\+Dot and D\+B\+Dot$\sim$$\sim$ 18.\+01.\+15
\item $\sim$$\sim$\+Electrode specific\+: Set potential value$\sim$$\sim$ 17.\+12.\+06
\end{DoxyItemize}
\end{DoxyItemize}

\subsubsection*{Layers}


\begin{DoxyItemize}
\item Layer editor updates in response to signals emitted from design panel
\begin{DoxyItemize}
\item Reset layer editor after loading new layout
\end{DoxyItemize}
\item $\sim$$\sim$\+Enumerated layer types$\sim$$\sim$ Implemented 18.\+01.\+15
\begin{DoxyItemize}
\item $\sim$$\sim$\+Provide enum to Q\+String conversion$\sim$$\sim$ 18.\+01.\+15
\item $\sim$$\sim$\+Also update save, load, export functions as the Enum strings are different from the original names$\sim$$\sim$ 18.\+01.\+15
\end{DoxyItemize}
\item A\+FM
\begin{DoxyItemize}
\item Path primitive object with snap to DB capabilities
\item Constant speed / acceleration profile / etc.
\begin{DoxyItemize}
\item Real time info of timing, etc.
\end{DoxyItemize}
\item Side view of A\+FM path allowing height adjustment and height movement profile, pop-\/up window when clicked on a segment
\end{DoxyItemize}
\item Create\+Layer with undo and redo in Design\+Panel
\item Add zheight property to layers (including updating functions in DP)
\item Layer\+Editor
\begin{DoxyItemize}
\item $\sim$$\sim$\+List layers$\sim$$\sim$ Implemented 18.\+01.\+15
\item Add layer
\item Rm layer
\item Rename layer (except for default layers)
\item $\sim$$\sim$\+Edit layer zheight$\sim$$\sim$ Implemented 18.\+01.\+16
\end{DoxyItemize}
\item Toggle layer state
\begin{DoxyItemize}
\item $\sim$$\sim$\+Layer visibility$\sim$$\sim$ Implemented 18.\+01.\+12
\item Layer editability
\begin{DoxyItemize}
\item Current \char`\"{}set\+Active()\char`\"{} in layer has not been implemented
\item Hiding a layer should also make it uneditable
\end{DoxyItemize}
\item Label visibility (labels can be stored within any layer when implemented)
\end{DoxyItemize}
\item Distinguishment between physical layer and logical layer
\begin{DoxyItemize}
\item Update code in physics engine
\end{DoxyItemize}
\end{DoxyItemize}

\subsubsection*{Aggregates}


\begin{DoxyItemize}
\item Save and load aggregates
\item Disallow creation of new dots inside aggregates
\item Offset of moving aggregates -\/ ghost should not be centered to the cursor, instead centered at the same offset as the starting point
\item Component library
\item Tight aggregate boundaries (instead of the current sqaure, taking up too much space)
\begin{DoxyItemize}
\item Multiple aggregate boundary algorithms, so we can choose the one that ensures the highest accuracy depending for the standard library.
\item Possibly implement Chan\textquotesingle{}s algorithm for faster convex hull computation
\item Right click on object to change the aggregate boundary algorithm, give out warning if they\textquotesingle{}re attempting to do this on an aggregate that came from a library
\item Associate hull computation wit changes to the aggregate rather than the \+::shape function (recomputes every time the boundary is painted/checked).
\end{DoxyItemize}
\item \char`\"{}flatten\+Aggregate\char`\"{} function\+: for each selected aggregate, for each child of that aggregate, split if an aggregate and add children to parent.
\item Enter aggregate to make changes inside the aggregate -\/ aggregate layers (like entering group in Inkscape)
\item $\sim$$\sim$\+Highlight group boundaries when mouse over aggregates$\sim$$\sim$ Implemented 17.\+07.\+12
\item $\sim$$\sim$\+Select parent aggregate when clicking on child aggregate$\sim$$\sim$ Implemented 17.\+07.\+12
\end{DoxyItemize}

\subsubsection*{Electrode Design}


\begin{DoxyItemize}
\item Side view of vertical electrode stack
\item $\sim$$\sim$\+Top view of electrode layers$\sim$$\sim$ 17.\+10.\+31
\item $\sim$$\sim$\+Creating, moving, copying, pasting, and deleting electrodes$\sim$$\sim$ 17.\+11.\+30
\item Snapping, aligning and distributing like Inkscape
\item $\sim$$\sim$\+Save/\+Load$\sim$$\sim$ 17.\+12.\+11
\item $\sim$$\sim$\+Setting potentials (individual and batch)$\sim$$\sim$ 17.\+11.\+03
\item $\sim$$\sim$\+Ghosting when moving Electrodes (individual and batch)$\sim$$\sim$
\end{DoxyItemize}

\subsubsection*{Config}


\begin{DoxyItemize}
\item Make config file paths configurable
\item User-\/friendly config file, custom functions in Q\+Settings to read from config to Q\+Setting\textquotesingle{}s own structure / writeback changed settings to user-\/readable file
\end{DoxyItemize}

\subsubsection*{Lattice}


\begin{DoxyItemize}
\item Background lattice sites -\/$>$ change to bitmap for efficiency
\item Order of a1 and a2 in get\+Lattice\+Inds matters (segfault)
\end{DoxyItemize}

\begin{quote}
solvers, physics engine, and I/O formatting \end{quote}
\subsection*{Physics Engine}


\begin{DoxyItemize}
\item Interface with solvers (standards for passing DB configuration to them, and taking results back)
\item Reset Sim\+Manager after design panel reset
\item Open new window for showing sim results
\item Custom class containing physical structure
\begin{DoxyItemize}
\item $\sim$$\sim$\+Import size and potential data for electrodes into solver$\sim$$\sim$
\item Translate size from Qt units to physical lengths
\item Add buffer region surrounding simulation area
\end{DoxyItemize}
\item Location, dimensions, etc
\begin{DoxyItemize}
\item Custom class containing properties
\end{DoxyItemize}
\item Simple estimation tool of electron distribution
\item Static or animated display of charge (like the A\+FM images)
\item Simulation visualization panel that allows users to control visualization of simulation results
\begin{DoxyItemize}
\item Control what type of result to show
\item Filter results, e.\+g. only show results with 2 electrons
\item Time control, if the simulator supports that
\item Degenerate state visualization
\item stuff like that
\end{DoxyItemize}
\item Sim\+Anneal
\begin{DoxyItemize}
\item Distance dependent hopping\+: precompute the probability of hopping from each site to any other site, put into matrix
\end{DoxyItemize}
\item Pois\+Solver
\begin{DoxyItemize}
\item $\sim$$\sim$\+Import size and potential data for electrodes into solver$\sim$$\sim$ 18.\+02.\+05
\item $\sim$$\sim$\+Translate size from Qt units to physical lengths$\sim$$\sim$ 18.\+01.\+05
\item $\sim$$\sim$\+Add buffer region surrounding simulation area$\sim$$\sim$ 18.\+01.\+05
\item $\sim$$\sim$\+Location, dimensions, etc$\sim$$\sim$ 17.\+10.\+18
\item $\sim$$\sim$\+Implement heat map/colour map support$\sim$$\sim$ 18.\+02.\+08
\item Create a UI file in Qt Designer
\item Add simulation parameter config similar to Sim\+Anneal
\end{DoxyItemize}
\end{DoxyItemize}

\begin{quote}
general bugs \end{quote}
\subsection*{Bugs}


\begin{DoxyItemize}
\item Segfault when undoing aggregates then moving dots
\item When attempting to select D\+Bs using rubberband but clicked on a D\+B/aggregate as the starting location, the object at the starting position takes the press event and rubberband fails to show
\end{DoxyItemize}

\begin{quote}
Todo list for the current branch \end{quote}
\subsection*{Ongoing}


\begin{DoxyItemize}
\item Interface with solvers (standards for passing DB configuration to them, and taking results back)
\begin{DoxyItemize}
\item Write data structure to xml
\begin{DoxyItemize}
\item Use normal save xml for now
\item In the X\+ML, add a section containing simulation parameters
\item Temperarily use an available xml parser for now, might change later (rapidxml?)
\item Material, material parameters/properties (that can be overidden by the simulator), DB locations
\item Aggregates (in the future\+: predetermined simulation parameters for aggregates can be stored)
\begin{DoxyItemize}
\item $\sim$$\sim$\+Electrode potential and size$\sim$$\sim$
\item A way to add a \char`\"{}buffer\char`\"{} region to the outer simulation boundaries.
\item Specification of potential simulation boundaries.
\item Translating the Q\+Point locations in Qt to physical locations in the simulation.
\item Ensuring that Electrodes do not overlap with each other.
\end{DoxyItemize}
\end{DoxyItemize}
\end{DoxyItemize}
\item Simple estimation tool of electron distribution
\begin{DoxyItemize}
\item Simulated annealing algorithm with 1. electron population determined by bulk-\/\+DB interaction and 2. inter-\/\+DB electron hopping.
\item Export results to file for gui to read -\/ time, charge distribution, etc
\end{DoxyItemize}
\end{DoxyItemize}

G\+UI side
\begin{DoxyItemize}
\item Get available engines
\begin{DoxyItemize}
\item Read engine properties from certain directory, properties are stored in X\+ML files
\item Simulation jobs are ran on a runtime temp directory that is structured as follows\+: \mbox{[}temp\+Dir\mbox{]}/\mbox{[}engine\+Dir\mbox{]}/\mbox{[}problem\+Dir\mbox{]}
\item For now, Sim\+Engine\+::runtime\+Temp\+Dir is hard coded to return the only physeng
\end{DoxyItemize}
\item Show simulation options
\begin{DoxyItemize}
\item Show options relevant to the selected engine
\end{DoxyItemize}
\item Problem and result files are stored in tmp
\begin{DoxyItemize}
\item Delete them when quiting program
\end{DoxyItemize}
\item Read simultion result
\begin{DoxyItemize}
\item Application\+G\+U\+I\+::read\+Sim\+Result still has many unfinished sections
\end{DoxyItemize}
\end{DoxyItemize}

The following mess was made before d-\/wave meeting, will consolidate into list above
\begin{DoxyItemize}
\item Rundown\+:
\begin{DoxyItemize}
\item Sim Setup (pick simulator, adjust simulation params)
\begin{DoxyItemize}
\item There should be flags in the simulator info X\+ML controlling what kind of params are exported.
\item Other simulation params are described in the simulator info X\+ML too I guess?
\end{DoxyItemize}
\item Run simulation, shows simulation text output
\begin{DoxyItemize}
\item X\+ML file describing the problem and parameters is saved to a specific directory that queues simulations. The binary of the simulator is called to run the simulation.
\end{DoxyItemize}
\item When simulation completes, allow users the following options\+: 1. visualize results (details of visualization, like filters and whatnot, should be handled by another widget I guess); 2. save simulation results
\begin{DoxyItemize}
\item Simulation results, corresponding params, energy levels, etc. should be stored to different classes?
\end{DoxyItemize}
\end{DoxyItemize}
\item Detect runtime error messages from the simulator and alert the user Short future\+:
\item Static or animated display of charge (like the A\+FM images)
\begin{DoxyItemize}
\item For degenerate states where the hop is of short distance? Might need to change the way the results are exported to make this easier.
\end{DoxyItemize}
\item Has a result screen that allows user to view previous results Future\+:
\item Show currently running jobs
\item For example, some jobs might be detailed simulation for small aggregates, while another crude simulation could be ongoing in the background.
\item If this widget is called from the main window while an instance of this is open, just focus such instance.
\item Assuming that sim takes a long time to run, and user makes changes to DB, when sim is complete user can open a new tab to view the results without disturbing the updated design.
\item gui\+::\+Design\+Panel\+::display\+Sim\+Results to handle multiple types of simulation results that should be shown
\end{DoxyItemize}

\begin{quote}
Past T\+O\+D\+Os for implementations of major features \end{quote}
\subsection*{Past detailed T\+O\+D\+Os}

\subsubsection*{save-\/load branch}

All tasks described here contribute to save/load functionality
\begin{DoxyItemize}
\item layer id related
\begin{DoxyItemize}
\item $\sim$$\sim$\+Change items to store layer id instead of layer pointer$\sim$$\sim$ Implemented 17.\+08.\+01
\item $\sim$$\sim$\+Add functionality to change layer id stored in layers and in child items when the layer\textquotesingle{}s index changes in the stack$\sim$$\sim$ Implemented 17.\+08.\+02
\item Clean up design panel code for layer id (make it less \textquotesingle{}hacked-\/together\textquotesingle{}, get rid of unnecessary converions)
\end{DoxyItemize}
\item $\sim$$\sim$\+Undo/\+Redo stack indexing$\sim$$\sim$ Implemented 17.\+08.\+16
\begin{DoxyItemize}
\item $\sim$$\sim$\+Make base class that always increments for each item added to the stack$\sim$$\sim$ Implemented 17.\+08.\+15
\item $\sim$$\sim$\+Each item stores the undo/redo stack I\+D$\sim$$\sim$ Implemented 17.\+08.\+15
\item $\sim$$\sim$\+When autosave/manual save are performed, store the stack id at which it was performed$\sim$$\sim$ Implemented 17.\+08.\+16
\end{DoxyItemize}
\item Saving
\begin{DoxyItemize}
\item $\sim$$\sim$\+Nested saving -\/ recursive$\sim$$\sim$ Implemented 17.\+08.\+09
\item $\sim$$\sim$\+File write error handling$\sim$$\sim$ Implemented 17.\+08.\+16
\end{DoxyItemize}
\item Loading
\begin{DoxyItemize}
\item $\sim$$\sim$\+Nested loading of items -\/ recursive$\sim$$\sim$ Implemented 17.\+08.\+11
\item $\sim$$\sim$\+Load screen offset, zoom and rotation$\sim$$\sim$ Implemented 17.\+08.\+23
\item Load layers with appropriate properties
\item Error alert dialog if latdot cannot be found during dbdot generation
\item Clean up the X\+ML read write code to have a consistent style
\end{DoxyItemize}
\item $\sim$$\sim$\+Save dialog when quitting$\sim$$\sim$ Implemented 17.\+08.\+16
\item Autosaving per x minutes
\begin{DoxyItemize}
\item $\sim$$\sim$\+Detect changes in program. If no changes, don\textquotesingle{}t run autosave.$\sim$$\sim$ Implemented 17.\+08.\+15
\item $\sim$$\sim$\+Number of saves$\sim$$\sim$ Implemented 17.\+08.\+16
\item $\sim$$\sim$\+Rotational save in a folder dedicated to that program instance$\sim$$\sim$ Implemented 17.\+08.\+16
\item Put tmp directory to system tmp?
\item Delete autosaves when quiting the program gracefully
\end{DoxyItemize}
\item autorecovery
\begin{DoxyItemize}
\item Check for existing autosaves, ask the user whether they want to recover the latest autosave.
\end{DoxyItemize}
\item Code improvement
\begin{DoxyItemize}
\item Q\+Lock\+File for locking instance folder during creation
\begin{DoxyItemize}
\item Or, get the process ID and use that as part of the directory name -\/ Q\+Core\+Application\+::application\+Pid() 
\end{DoxyItemize}
\end{DoxyItemize}
\end{DoxyItemize}